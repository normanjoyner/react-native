FROM containership/android-base:latest

# temporary hack for adb timeout
WORKDIR /home/ubuntu/buck
RUN sed -i 's/ADB_CONNECT_TIMEOUT_MS\ =\ 5000/ADB_CONNECT_TIMEOUT_MS\ =\ 60000/' src/com/facebook/buck/android/AdbHelper.java
RUN sed -i 's/ADB_CONNECT_TIMEOUT_MS\ =\ 5000/ADB_CONNECT_TIMEOUT_MS\ =\ 60000/' src/com/facebook/buck/testrunner/InstrumentationTestRunner.java
RUN ant
WORKDIR /app

# run buck fetches since we modified codebase
RUN buck fetch ReactAndroid/src/test/java/com/facebook/react/modules
RUN buck fetch ReactAndroid/src/main/java/com/facebook/react
RUN buck fetch ReactAndroid/src/main/java/com/facebook/react/shell
RUN buck fetch ReactAndroid/src/test/...
RUN buck fetch ReactAndroid/src/androidTest/...

# move back to base image
RUN npm install n -g
RUN n 6.2.0
RUN echo "y" | android update sdk -u -a -t 131

ENV ANDROID_SDK_ROOT=/home/ubuntu/android

ADD scripts/run-android-ci-instrumentation-tests.js /app/scripts/run-android-ci-instrumentation-tests.js

CMD bash test.sh
